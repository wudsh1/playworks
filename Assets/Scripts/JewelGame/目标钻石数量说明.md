# 目标钻石数量 - 自动统计说明

## 🎯 核心逻辑

### ✅ 新逻辑（正确）

**目标钻石数量 = 游戏开始时统计的初始钻石数量**

```
游戏初始化
↓
统计游戏板上的钻石数量
↓
设置为目标钻石数量
↓
玩家消除钻石
↓
剩余钻石数量减少
↓
当剩余钻石 = 0 → 胜利！
```

### ❌ 旧逻辑（错误）

~~目标钻石数量 = 固定配置值（如 0）~~

---

## 📊 工作原理

### 1. 游戏初始化时

```csharp
// 游戏板初始化完成后
OnDiamondCountChanged(5) 被调用
↓
检测到：_targetDiamondCount == 0 且 count > 0 且 !_hasPlayerMoved
↓
设置：_targetDiamondCount = 5
↓
日志：[游戏逻辑] 初始化目标钻石数量: 5
```

### 2. 游戏进行中

```csharp
// 玩家消除包含钻石的行
OnDiamondCountChanged(3) 被调用
↓
更新：_diamondCount = 3
↓
日志：[游戏逻辑] 钻石数量变化: 3/5
↓
检查胜负条件
```

### 3. 胜利判定

```csharp
// 最后一个钻石被消除
OnDiamondCountChanged(0) 被调用
↓
更新：_diamondCount = 0
↓
检查：_diamondCount == 0
↓
日志：[游戏逻辑] ✅ 胜利！（初始:5 → 当前:0）
↓
等待 1 秒 → 跳转商店
```

---

## 🔧 代码实现

### 关键变量

```csharp
private int _diamondCount = 0;        // 当前剩余钻石数量
private int _targetDiamondCount = 0;  // 目标钻石数量（初始统计）
```

### 自动统计逻辑

```csharp
private void OnDiamondCountChanged(int count)
{
    _diamondCount = count;
    
    // 🎯 关键：游戏刚开始时记录初始钻石数量
    if (_targetDiamondCount == 0 && count > 0 && !_hasPlayerMoved)
    {
        _targetDiamondCount = count;
        Debug.Log($"[游戏逻辑] 初始化目标钻石数量: {_targetDiamondCount}");
    }
    
    Debug.Log($"[游戏逻辑] 钻石数量变化: {count}/{_targetDiamondCount}");
    
    UpdateUI();
    CheckWinLoseConditions();
}
```

### 胜利条件

```csharp
private void CheckWinLoseConditions()
{
    if (_gameOver) return;
    
    // 只有在玩家移动过且已设置目标后才检查
    if (!_hasPlayerMoved || _targetDiamondCount == 0) return;
    
    // 🎯 胜利条件：钻石数量为 0
    if (_diamondCount == 0)
    {
        Debug.Log($"[游戏逻辑] ✅ 胜利！所有钻石已收集完成（初始:{_targetDiamondCount} → 当前:0）");
        StartCoroutine(OnGameWin());
        return;
    }
    
    // 失败条件：步数用完且钻石未收集完
    if (_remainingMoves <= 0 && _diamondCount > 0)
    {
        Debug.Log($"[游戏逻辑] ❌ 失败！步数用完，剩余钻石: {_diamondCount}/{_targetDiamondCount}");
        StartCoroutine(OnGameLose());
        return;
    }
}
```

---

## 📝 游戏流程示例

### 场景 1：成功收集

```
【游戏开始】
钻石数量: 5 个（自动统计）
目标: 收集所有 5 个钻石
步数: 6 步

【第1次移动】
消除1行（包含 2 个钻石）
剩余钻石: 3/5 ✨
剩余步数: 5

【第2次移动】
消除1行（包含 2 个钻石）
剩余钻石: 1/5 ✨
剩余步数: 4

【第3次移动】
消除1行（包含 1 个钻石）
剩余钻石: 0/5 ✨✅
→ 胜利！跳转商店
```

### 场景 2：失败（步数用完）

```
【游戏开始】
钻石数量: 5 个（自动统计）
目标: 收集所有 5 个钻石
步数: 6 步

【第1-5次移动】
消除了 3 个钻石
剩余钻石: 2/5
剩余步数: 1

【第6次移动】
未消除钻石
剩余钻石: 2/5 ❌
剩余步数: 0
→ 失败！跳转商店
```

---

## 🧪 控制台日志示例

### 游戏初始化

```
[游戏逻辑] 初始化目标钻石数量: 5
[游戏逻辑] 钻石数量变化: 5/5
```

### 消除钻石

```
[游戏逻辑] 移动完成，剩余步数: 5, 剩余钻石: 3
[游戏逻辑] 钻石数量变化: 3/5
```

### 胜利

```
[游戏逻辑] 钻石数量变化: 0/5
[游戏逻辑] ✅ 胜利！所有钻石已收集完成（初始:5 → 当前:0）
[游戏逻辑] 游戏胜利，准备跳转商店
[游戏逻辑] 跳转商店（胜利）
```

### 失败

```
[游戏逻辑] 移动完成，剩余步数: 0, 剩余钻石: 2
[游戏逻辑] ❌ 失败！步数用完，剩余钻石: 2/5
[游戏逻辑] 游戏失败，准备跳转商店
[游戏逻辑] 跳转商店（失败）
```

---

## ⚙️ 配置说明

### Unity Inspector

**无需手动配置目标钻石数量！**

系统会自动统计，你只需要配置：

```
JewelGameManager 组件：

【游戏规则配置】
✅ Initial Moves: 6     // 初始步数（可调整）

【商店导航】
✅ Store Navigator      // 商店导航器（自动查找）
```

### 关卡设计

如果想调整难度，可以：

1. **调整初始步数**
   - 简单：8-10 步
   - 中等：6-7 步
   - 困难：4-5 步

2. **调整钻石生成概率**
   - 在 `JewelBoardConfig` 中调整 `DiamondWeight`
   - 更多钻石 = 更难收集完

3. **使用关卡数据**
   - 在 `JewelLevelData` 中预设初始布局
   - 精确控制钻石数量和位置

---

## 🔍 调试技巧

### 查看目标钻石数量

在游戏运行时，观察控制台日志：

```
[游戏逻辑] 初始化目标钻石数量: X
```

这个 `X` 就是本局游戏需要收集的钻石总数。

### 查看当前进度

```
[游戏逻辑] 钻石数量变化: 当前数量/目标数量
```

例如：`3/5` 表示还剩 3 个钻石，目标是收集 5 个。

### 验证胜利条件

当看到以下日志时，说明胜利逻辑正确触发：

```
[游戏逻辑] ✅ 胜利！所有钻石已收集完成（初始:5 → 当前:0）
```

---

## 🐛 常见问题

### Q1: 游戏一开始就判定胜利？

**原因**：初始化时钻石数量为 0

**排查**：
1. 检查 `JewelBoardManager` 是否正确生成钻石
2. 查看控制台日志中的初始钻石数量
3. 检查 `DiamondWeight` 配置是否为 0

### Q2: 目标钻石数量没有被设置？

**排查**：
1. 查看控制台是否有 `初始化目标钻石数量` 日志
2. 确认 `OnDiamondCountChanged` 被正确调用
3. 检查初始化顺序

### Q3: 胜利条件不触发？

**排查**：
1. 检查 `_diamondCount` 是否真的为 0
2. 查看日志中的钻石数量变化
3. 确认 `_hasPlayerMoved` 标志正确
4. 确认 `_targetDiamondCount` 已设置

### Q4: 想手动设置目标钻石数量？

**不推荐**，但如果需要：

```csharp
// 在 InitializeGame 中手动设置
_targetDiamondCount = 特定数量;
```

**推荐方式**：使用关卡数据精确控制初始钻石数量

---

## 📚 相关代码

- **JewelGameManager.cs** - 游戏逻辑管理
  - `OnDiamondCountChanged()` - 钻石数量变化处理
  - `CheckWinLoseConditions()` - 胜负判定
- **JewelBoardManager.cs** - 游戏板管理
  - `OnDiamondCountChanged` 事件 - 钻石数量变化通知
- **JewelBlockData.cs** - 方块数据
  - `IsDiamond()` - 判断是否为钻石块

---

## ✨ 总结

✅ **自动统计**：游戏开始时自动统计钻石数量  
✅ **动态目标**：根据实际游戏板设置目标  
✅ **清晰逻辑**：当前数量 = 0 就是胜利  
✅ **详细日志**：所有关键步骤都有日志输出  
✅ **易于调试**：通过日志可以清楚看到游戏进度  

这是一个更合理、更灵活的目标系统！🎯🚀













