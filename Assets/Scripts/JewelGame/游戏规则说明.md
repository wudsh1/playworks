# 宝石游戏规则说明

## 🎯 游戏目标

在**规定步数内**收集完**所有钻石**，成功后跳转到应用商店。

---

## 📊 游戏机制

### 1️⃣ 步数系统（倒计时）

- **初始步数**：6 步（可在 Inspector 中配置）
- **显示位置**：右上角
- **计数方式**：**倒计时**（从 6 递减到 0）
- **每次移动**：剩余步数 -1

```
初始: 6 步
移动1次: 5 步
移动2次: 4 步
...
移动6次: 0 步
```

### 2️⃣ 钻石收集（核心玩法）⭐

- **目标设定**：游戏开始时**自动统计**当前游戏板上的钻石数量作为目标
- **目标显示**：左上角显示**当前剩余钻石数量**
- **收集方式**：消除包含钻石的行
- **胜利条件**：将钻石数量降低到 **0**（收集完所有钻石）

**示例**：
```
游戏开始：统计到 5 个钻石 → 目标: 收集 5 个钻石
消除1行（2个钻石）：剩余 3 个钻石
消除1行（2个钻石）：剩余 1 个钻石
消除1行（1个钻石）：剩余 0 个钻石 → ✅ 胜利！
```

### 3️⃣ 胜负判定

#### ✅ 胜利条件
```
钻石数量 = 0（收集完所有钻石）
→ 显示胜利动画（1秒）
→ 自动跳转应用商店
```

#### ❌ 失败条件
```
剩余步数 = 0 且 钻石数量 > 0
→ 显示失败提示（1秒）
→ 自动跳转应用商店
```

---

## 🎮 游戏流程

### 正常游戏流程

```
1. 游戏开始 → 剩余步数: 6，钻石数量: N
   ↓
2. 玩家移动方块（步数 -1）
   ↓
3. 消除行（可能包含钻石）
   ↓
4. 检查胜负条件：
   - 钻石 = 0？ → 胜利 → 跳转商店
   - 步数 = 0 且 钻石 > 0？ → 失败 → 跳转商店
   - 否则继续游戏
   ↓
5. 返回步骤 2
```

### 示例场景

#### 场景A：成功收集（第3步）
```
初始: 步数=6, 钻石=5
移动1: 步数=5, 钻石=3 (消除2个钻石)
移动2: 步数=4, 钻石=1 (消除2个钻石)
移动3: 步数=3, 钻石=0 (消除最后1个钻石)
→ ✅ 胜利！跳转商店
```

#### 场景B：步数用完（失败）
```
初始: 步数=6, 钻石=5
移动1: 步数=5, 钻石=5 (未消除钻石)
移动2: 步数=4, 钻石=4 (消除1个钻石)
移动3: 步数=3, 钻石=4 (未消除钻石)
移动4: 步数=2, 钻石=3 (消除1个钻石)
移动5: 步数=1, 钻石=3 (未消除钻石)
移动6: 步数=0, 钻石=2 (消除1个钻石)
→ ❌ 失败！步数用完但钻石还剩2个 → 跳转商店
```

---

## ⚙️ Inspector 配置

### JewelGameManager 组件

在 Unity Inspector 中配置：

```
【游戏规则配置】
Initial Moves: 6              // 初始剩余步数

【商店导航】
Store Navigator: StoreNavigator  // 商店导航器引用
                                // （自动查找，也可手动指定）
```

### 配置说明

#### Initial Moves（初始步数）
- **默认值**: 6 步
- **建议范围**: 5-10 步
- 根据关卡难度调整：
  - 简单关卡：8-10 步
  - 中等关卡：6-7 步
  - 困难关卡：4-5 步

#### 目标钻石数量（自动统计）⭐
- **说明**: 游戏开始时**自动统计**当前游戏板上的钻石数量
- **无需配置**: 系统自动检测并设置目标
- **胜利条件**: 将钻石数量降低到 0

**工作原理**：
```csharp
// 游戏初始化时
钻石数量变化 → 记录初始数量为目标
例如：检测到 5 个钻石 → _targetDiamondCount = 5

// 游戏进行中
每次消除钻石 → _diamondCount 减少
当 _diamondCount = 0 → 胜利！
```

---

## 🔧 技术实现

### 核心逻辑

#### 1. 步数倒计时
```csharp
// 移动完成回调
private void OnMoveMade()
{
    _remainingMoves--;  // 每次移动减少1步
    UpdateUI();
    CheckWinLoseConditions();  // 检查胜负
}
```

#### 2. 钻石数量监控与目标设定 ⭐
```csharp
// 钻石数量变化回调
private void OnDiamondCountChanged(int count)
{
    _diamondCount = count;
    
    // 游戏刚开始时，记录初始钻石数量作为目标
    if (_targetDiamondCount == 0 && count > 0 && !_hasPlayerMoved)
    {
        _targetDiamondCount = count;
        Debug.Log($"初始化目标钻石数量: {_targetDiamondCount}");
    }
    
    UpdateUI();
    CheckWinLoseConditions();  // 检查胜负
}
```

#### 3. 胜负判定
```csharp
private void CheckWinLoseConditions()
{
    if (_gameOver) return;
    
    // 只有在玩家移动过且已设置目标后才检查
    if (!_hasPlayerMoved || _targetDiamondCount == 0) return;
    
    // 胜利：钻石数量为 0（收集完所有）
    if (_diamondCount == 0)
    {
        Debug.Log($"✅ 胜利！（初始:{_targetDiamondCount} → 当前:0）");
        StartCoroutine(OnGameWin());
        return;
    }
    
    // 失败：步数用完且钻石未收集完
    if (_remainingMoves <= 0 && _diamondCount > 0)
    {
        Debug.Log($"❌ 失败！剩余钻石: {_diamondCount}/{_targetDiamondCount}");
        StartCoroutine(OnGameLose());
        return;
    }
}
```

#### 4. 自动跳转商店
```csharp
// 胜利
private IEnumerator OnGameWin()
{
    _gameOver = true;
    yield return new WaitForSeconds(1.0f);
    StoreNavigator.OpenStore();  // 跳转商店
}

// 失败
private IEnumerator OnGameLose()
{
    _gameOver = true;
    yield return new WaitForSeconds(1.0f);
    StoreNavigator.OpenStore();  // 跳转商店
}
```

---

## 🎨 UI 显示

### 右上角 - 剩余步数
```
📍 显示位置: 右上角
📊 显示内容: 6 → 5 → 4 → 3 → 2 → 1 → 0
🎯 组件: MovesText (ImageNumberDisplay)
```

### 左上角 - 钻石数量
```
📍 显示位置: 左上角（钻石图标旁）
📊 显示内容: 当前场上的钻石块数量
🎯 组件: DiamondCountText (ImageNumberDisplay)
💎 目标: 降低到 0
```

---

## 📝 开发日志

### 代码修改

#### JewelGameManager.cs 主要修改

1. **添加配置项**
   - `InitialMoves = 6` - 初始步数
   - `TargetDiamondCount = 0` - 目标钻石数
   - `StoreNavigator` 引用 - 商店导航器

2. **修改步数逻辑**
   - ❌ 删除 `_movesCount`（累计步数）
   - ✅ 添加 `_remainingMoves`（剩余步数）
   - ✅ `OnMoveMade()` 改为减少步数

3. **添加胜负判定**
   - ✅ `CheckWinLoseConditions()` - 检查胜负
   - ✅ `OnGameWin()` - 胜利处理
   - ✅ `OnGameLose()` - 失败处理

4. **自动跳转商店**
   - ✅ 胜利/失败后等待 1 秒
   - ✅ 调用 `StoreNavigator.OpenStore()`

---

## 🧪 测试清单

### 基础功能测试

- [ ] 游戏开始时步数显示为 6
- [ ] 每次移动后步数减少 1
- [ ] 步数显示正确更新（6→5→4...）
- [ ] 钻石数量显示正确

### 胜利条件测试

- [ ] 钻石数量为 0 时触发胜利
- [ ] 播放胜利动画（角色笑）
- [ ] 等待 1 秒后跳转商店
- [ ] 控制台输出正确日志

### 失败条件测试

- [ ] 步数为 0 且钻石 > 0 时触发失败
- [ ] 等待 1 秒后跳转商店
- [ ] 控制台输出正确日志

### 商店跳转测试

- [ ] StoreNavigator 正确配置
- [ ] iOS 设备跳转到 App Store
- [ ] Android 设备跳转到 Google Play
- [ ] Luna Playable 中平台检测正确

---

## 🐛 常见问题

### Q1: 步数显示不正确？
**A**: 检查：
- `MovesText` 是否正确引用 `ImageNumberDisplay` 组件
- `InitialMoves` 是否设置为 6

### Q2: 胜利/失败后没有跳转商店？
**A**: 检查：
- `StoreNavigator` 是否正确引用
- 控制台是否有错误日志
- StoreNavigator 是否配置了 App ID 和包名

### Q3: 游戏不判定胜负？
**A**: 检查：
- 是否调用了 `CheckWinLoseConditions()`
- 控制台日志中的钻石数量和步数是否正确
- `_gameOver` 标志是否正确

### Q4: 想调整初始步数？
**A**: 在 Inspector 中修改 `Initial Moves` 值：
- 测试：设置为 50（方便测试）
- 正式：设置为 6-8（根据难度）

---

## 📚 相关文档

- **StoreNavigator.cs** - 商店跳转逻辑
- **Luna平台检测集成指南.md** - Luna Playable 平台检测
- **Free to Play按钮快速集成.md** - 商店按钮集成

---

## ✨ 总结

✅ **步数倒计时**：从 6 递减到 0  
✅ **目标明确**：收集完所有钻石（钻石数 = 0）  
✅ **自动判定**：胜利或失败自动检测  
✅ **自动跳转**：结束后自动跳转应用商店  

这是一个完整的 Playable Ads 游戏循环！🚀

